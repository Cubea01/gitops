clusterName: k8s

talosVersion: v1.5.2
kubernetesVersion: 1.28.1
endpoint: https://k8s.akchristiansen.com:6443

cniConfig:
  name: none

additionalMachineCertSans:
  - k8s.akchristiansen.com
  - 10.0.3.1
additionalApiServerCertSans:
  - 10.0.3.1
clusterPodNets:
  - 10.244.0.0/16
clusterSvcNets:
  - 10.96.0.0/12

nodes:
  - hostname: node1.akchristiansen.com
    disableSearchDomain: true
    ipAddress: 10.0.3.3
    controlPlane: true
    installDiskSelector:
      type: ssd
    networkInterfaces:
      - interface: bond0
        dhcp: true
        mtu: 9000
        bond:
          mode: balance-rr
          deviceSelectors:
            - hardwareAddr: '${node1NIC1}'
            - hardwareAddr: '${node1NIC2}'
            - hardwareAddr: '${node1NIC3}'
            - hardwareAddr: '${node1NIC4}'
            - hardwareAddr: '${node1NIC5}'
            - hardwareAddr: '${node1NIC6}'
  - hostname: node2.akchristiansen.com
    disableSearchDomain: true
    ipAddress: 10.0.3.4
    installDiskSelector:
      type: ssd
    controlPlane: true
    networkInterfaces:
      - interface: bond0
        dhcp: true
        mtu: 9000
        bond:
          mode: balance-rr
          deviceSelectors:
            - hardwareAddr: '${node2NIC1}'
            - hardwareAddr: '${node2NIC2}'
            - hardwareAddr: '${node2NIC3}'
            - hardwareAddr: '${node2NIC4}'
            - hardwareAddr: '${node2NIC5}'
            - hardwareAddr: '${node2NIC6}'
  - hostname: node3.akchristiansen.com
    disableSearchDomain: true
    ipAddress: 10.0.3.5
    controlPlane: true
    installDiskSelector:
      type: ssd
    networkInterfaces:
      - interface: br0
        dhcp: true
        mtu: 9000
        bond:
          mode: balance-rr
          deviceSelectors:
            - hardwareAddr: '${node3NIC1}'
            - hardwareAddr: '${node3NIC2}'
            - hardwareAddr: '${node3NIC3}'
            - hardwareAddr: '${node3NIC4}'
            - hardwareAddr: '${node3NIC5}'
            - hardwareAddr: '${node3NIC6}'
controlPlane:
  patches:
    - "@./inlinemanifests.yaml"
    - |-
      cluster:
        allowSchedulingOnMasters: true
        etcd:
          advertisedSubnets:
            - 10.0.3.0/24
        proxy:
          disabled: true
        # apiServer:
        #   admissionControl:
        #     - name: PodSecurity
        #       configuration:
        #         apiVersion: pod-security.admission.config.k8s.io/v1alpha1
        #         defaults:
        #           audit: baseline
        #           audit-version: latest
        #           enforce: privileged
        #           enforce-version: latest
        #           warn: baseline
        #           warn-version: latest
    - |-
      - op: remove
        path: /cluster/apiServer/admissionControl
    - |-
      machine:
        kubelet:
          extraArgs:
            feature-gates: CronJobTimeZone=true,GracefulNodeShutdown=true
            rotate-server-certificates: "true"
        network:
          extraHostEntries:
            - ip: 10.0.3.1
              aliases:
                - k8s.akchristiansen.com
        time:
          disabled: false
          servers:
            - pool.ntp.org
        features:
          kubePrism:
            enabled: true
            port: 7445
        systemDiskEncryption:
          ephemeral:
            provider: luks2
            keys:
              - nodeID: {}
                slot: 0
          state:
            provider: luks2
            keys:
              - nodeID: {}
                slot: 0
        install:
          extensions:
            - image: ghcr.io/siderolabs/bnx2-bnx2x:20230804
            - image: ghcr.io/siderolabs/iscsi-tools:v0.1.4
            - image: ghcr.io/siderolabs/nonfree-kmod-nvidia:535.54.03-v1.5.2
            - image: ghcr.io/siderolabs/nvidia-container-toolkit:535.54.03-v1.13.5
        kernel:
          modules:
            - name: nvidia
            - name: nvidia_uvm
            - name: nvidia_drm
            - name: nvidia_modeset
        sysctls:
          fs.inotify.max_user_watches: "1048576"
          fs.inotify.max_user_instances: "8192"
          fs.file-max: "9223372036854775807"
          net.core.rmem_max: "33554432"
          net.core.wmem_max: "33554432"
          net.core.bpf_jit_harden: 1